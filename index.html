<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ãƒ‡ãƒ¼ã‚¿ã§åŒ—ä¸Šï¼æ—¥æœ¬åˆ—å³¶æ¨ªæ–­ã‚²ãƒ¼ãƒ </title>
<style>
    :root {
        --primary: #2c3e50;
        --accent: #e74c3c;
        --good: #27ae60;
        --bad: #8e44ad;
        --bg: #ecf0f1;
        --map-fill: #bdc3c7;
        --map-active: #f1c40f;
        --map-visited: #95a5a6;
    }
    body {
        font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--primary);
        color: #333;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    header {
        background: #fff;
        padding: 10px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 10;
        flex-shrink: 0;
    }
    h1 { font-size: 1.2rem; margin: 0; color: var(--primary); }
    .status-bar { font-size: 0.9rem; margin-top: 5px; display: flex; justify-content: space-around; }
    
    /* ãƒãƒƒãƒ—ã‚¨ãƒªã‚¢ */
    #game-area {
        flex-grow: 1;
        position: relative;
        background: #85C1E9; /* æµ·ã®è‰² */
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    svg {
        width: 100%;
        height: 100%;
        max-width: 800px;
        filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
    }
    .pref {
        fill: var(--map-fill);
        stroke: #fff;
        stroke-width: 0.5;
        transition: fill 0.3s;
        cursor: pointer;
    }
    .pref.visited { fill: var(--map-visited); }
    .pref.current { fill: var(--accent); animation: pulse 1.5s infinite; }
    .pref.neighbor { fill: var(--map-active); }
    .pref.goal { fill: var(--good); }

    @keyframes pulse {
        0% { fill: var(--accent); }
        50% { fill: #ff7675; }
        100% { fill: var(--accent); }
    }

    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
    #controls {
        background: #fff;
        padding: 15px;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        flex-shrink: 0;
        z-index: 20;
    }
    .guide-text { text-align: center; margin-bottom: 10px; font-weight: bold; }
    .options-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    button.option-btn {
        background: var(--primary);
        color: #fff;
        border: none;
        padding: 15px;
        border-radius: 10px;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.1s;
    }
    button.option-btn:active { transform: scale(0.95); }
    button.option-btn:disabled { background: #ccc; cursor: default; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #modal {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
    }
    #modal.show { opacity: 1; pointer-events: auto; }
    .modal-content {
        background: #fff;
        width: 90%;
        max-width: 500px;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        transform: translateY(20px);
        transition: transform 0.3s;
    }
    #modal.show .modal-content { transform: translateY(0); }
    
    .result-badge {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        color: #fff;
        font-weight: bold;
        margin-bottom: 10px;
    }
    .res-good { background: var(--good); }
    .res-bad { background: var(--bad); }
    
    .data-display {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 10px;
        margin: 15px 0;
        text-align: left;
    }
    .data-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px dashed #ccc;
    }
    .data-row.winner { color: var(--accent); font-weight: bold; }
    
    .next-btn {
        background: var(--accent);
        color: white;
        border: none;
        padding: 10px 30px;
        border-radius: 30px;
        font-size: 1.1rem;
        margin-top: 15px;
        cursor: pointer;
    }

    /* ã‚¨ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ« */
    #endroll {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9);
        color: white;
        z-index: 200;
        display: none;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
    }
    .history-item {
        background: rgba(255,255,255,0.1);
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        width: 100%;
        max-width: 600px;
        display: flex;
        justify-content: space-between;
    }
    /* ç´™å¹é›ªç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ */
    #confetti {
        position: absolute;
        top:0; left:0; width:100%; height:100%;
        pointer-events: none;
        z-index: 150;
    }
</style>
</head>
<body>

<header>
    <h1>ãƒ‡ãƒ¼ã‚¿ã§åŒ—ä¸Šï¼æ—¥æœ¬åˆ—å³¶æ¨ªæ–­</h1>
    <div class="status-bar">
        <span>ç¾åœ¨åœ°: <strong id="curr-pref-name">æ²–ç¸„çœŒ</strong></span>
        <span>ã‚´ãƒ¼ãƒ«ã¾ã§: ç´„<strong id="dist-count">--</strong>çœŒ</span>
        <span>ã‚¿ãƒ¼ãƒ³: <strong id="turn-count">1</strong></span>
    </div>
</header>

<div id="game-area">
    <canvas id="confetti"></canvas>
    <!-- ç°¡æ˜“æ—¥æœ¬åœ°å›³SVG (ãƒ‘ã‚¹ã¯ç°¡ç•¥åŒ–ã—ã¦ã„ã¾ã™) -->
    <svg id="japan-map" viewBox="0 0 1000 1000">
        <!-- JSã§ãƒ‘ã‚¹ã‚’ç”Ÿæˆã—ã¦æ³¨å…¥ -->
    </svg>
</div>

<div id="controls">
    <div class="guide-text">éš£ã®çœŒã¨æ¯”è¼ƒã—ã¦å¤§ãã„æ•°å­—ã‚’é¸ã¹ï¼</div>
    <div class="options-grid" id="options-container">
        <!-- JSã§ãƒœã‚¿ãƒ³ç”Ÿæˆ -->
    </div>
</div>

<!-- çµæœè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal">
    <div class="modal-content">
        <h2 id="modal-title">åˆ¤å®šçµæœ</h2>
        <div id="modal-badge" class="result-badge">--</div>
        <p id="modal-msg">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
        <div class="data-display" id="modal-data">
            <!-- ãƒ‡ãƒ¼ã‚¿æ¯”è¼ƒè¡¨ -->
        </div>
        <div style="font-size:0.9rem; color:#555; text-align:left; background:#eee; padding:10px; border-radius:5px;">
            <strong style="display:block; margin-bottom:5px;">ğŸ’¡ åœ°ç†ãƒ¡ãƒ¢</strong>
            <span id="modal-memo">è§£èª¬ãƒ†ã‚­ã‚¹ãƒˆ</span>
        </div>
        <button class="next-btn" onclick="game.closeModal()">æ¬¡ã¸é€²ã‚€</button>
    </div>
</div>

<!-- ã‚¨ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ«ç”»é¢ -->
<div id="endroll">
    <h1 style="color: gold; text-shadow: 0 0 10px orange;">GOAL! åŒ—æµ·é“åˆ°é”!</h1>
    <p>ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼é•·ã„æ—…è·¯ã§ã—ãŸã€‚</p>
    <h3>æ—…ã®æŒ¯ã‚Šè¿”ã‚Š</h3>
    <div id="history-list" style="width:100%; max-width:600px;"></div>
    <button class="next-btn" onclick="location.reload()" style="margin-top:30px; background:white; color:#333;">ã‚‚ã†ä¸€åº¦éŠã¶</button>
</div>

<script>
/**
 * ç°¡æ˜“ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ï¼ˆåŠ¹æœéŸ³ç”¨ï¼‰
 * Web Audio APIã‚’ä½¿ç”¨ã—ã¦å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ãªã—ã§éŸ³ã‚’é³´ã‚‰ã™
 */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const Sound = {
    playTone: (freq, type, duration) => {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    },
    ok: () => {
        Sound.playTone(600, 'sine', 0.1);
        setTimeout(() => Sound.playTone(800, 'sine', 0.4), 100);
    },
    bad: () => {
        Sound.playTone(150, 'sawtooth', 0.3);
        setTimeout(() => Sound.playTone(100, 'sawtooth', 0.4), 200);
    },
    move: () => {
        Sound.playTone(300, 'triangle', 0.1);
    },
    drum: () => {
        // ç°¡æ˜“ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«é¢¨ãƒã‚¤ã‚º
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const bufferSize = audioCtx.sampleRate * 0.1;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for(let i=0; i<bufferSize; i++) data[i] = Math.random() * 2 - 1;
        
        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;
        const gain = audioCtx.createGain();
        gain.gain.value = 0.05;
        noise.connect(gain);
        gain.connect(audioCtx.destination);
        noise.start();
    },
    fanfare: () => {
        [440, 554, 659, 880].forEach((f, i) => {
            setTimeout(() => Sound.playTone(f, 'square', 0.5), i * 150);
        });
        setTimeout(() => {
             [440, 554, 659, 880, 1108].forEach(f => Sound.playTone(f, 'square', 1.0));
        }, 600);
    }
};

/**
 * ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
 * (47éƒ½é“åºœçœŒã®ç°¡æ˜“ãƒ‡ãƒ¼ã‚¿)
 * ID: 1(åŒ—æµ·é“) ã€œ 47(æ²–ç¸„) â€»JISã‚³ãƒ¼ãƒ‰æº–æ‹ 
 * 
 * çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®æ„å‘³:
 * - pop: äººå£(ä¸‡äºº)
 * - area: é¢ç©(km2)
 * - temp: å¹´å¹³å‡æ°—æ¸©(â„ƒ)
 * - apple: ãƒªãƒ³ã‚´åç©«é‡(t) â€»0ãŒå¤šã„ã®ã§ç½ ã«ãªã‚‹
 * - conv: ã‚³ãƒ³ãƒ“ãƒ‹åº—èˆ—æ•°
 * - shrine: ç¥ç¤¾ã®æ•°
 */
const PREF_DATA = [
    {id:1, name:"åŒ—æµ·é“", pos:[800,150], adj:[2], stats:{pop:522, area:83424, temp:8.9, apple:48600, conv:3000, shrine:1000}},
    {id:2, name:"é’æ£®çœŒ", pos:[800,300], adj:[1,3,5], stats:{pop:123, area:9646, temp:10.4, apple:463600, conv:400, shrine:800}},
    {id:3, name:"å²©æ‰‹çœŒ", pos:[820,380], adj:[2,4,5], stats:{pop:121, area:15275, temp:10.6, apple:47600, conv:380, shrine:700}},
    {id:4, name:"å®®åŸçœŒ", pos:[820,450], adj:[3,5,6,7], stats:{pop:230, area:7282, temp:12.5, apple:4500, conv:1200, shrine:900}},
    {id:5, name:"ç§‹ç”°çœŒ", pos:[780,380], adj:[2,3,4,6], stats:{pop:95, area:11638, temp:11.7, apple:34300, conv:300, shrine:600}},
    {id:6, name:"å±±å½¢çœŒ", pos:[780,450], adj:[4,5,7,15], stats:{pop:106, area:9323, temp:11.9, apple:42900, conv:350, shrine:1500}},
    {id:7, name:"ç¦å³¶çœŒ", pos:[800,500], adj:[4,6,8,9,10,15], stats:{pop:183, area:13784, temp:13.1, apple:23800, conv:800, shrine:1600}},
    {id:8, name:"èŒ¨åŸçœŒ", pos:[820,550], adj:[7,9,11,12], stats:{pop:286, area:6097, temp:14.3, apple:800, conv:1500, shrine:1800}},
    {id:9, name:"æ ƒæœ¨çœŒ", pos:[780,530], adj:[7,8,10,11], stats:{pop:193, area:6408, temp:13.7, apple:1200, conv:1100, shrine:1200}},
    {id:10, name:"ç¾¤é¦¬çœŒ", pos:[750,530], adj:[7,9,11,15,20], stats:{pop:193, area:6362, temp:14.8, apple:4900, conv:1200, shrine:1300}},
    {id:11, name:"åŸ¼ç‰çœŒ", pos:[780,560], adj:[8,9,10,12,13,19,20], stats:{pop:734, area:3797, temp:15.4, apple:100, conv:3200, shrine:1500}},
    {id:12, name:"åƒè‘‰çœŒ", pos:[810,600], adj:[8,11,13,14], stats:{pop:628, area:5157, temp:16.2, apple:0, conv:3100, shrine:2500}},
    {id:13, name:"æ±äº¬éƒ½", pos:[780,580], adj:[11,12,14,19], stats:{pop:1400, area:2194, temp:16.5, apple:0, conv:7800, shrine:1400}},
    {id:14, name:"ç¥å¥ˆå·çœŒ", pos:[780,600], adj:[12,13,19,22], stats:{pop:920, area:2416, temp:16.6, apple:0, conv:4300, shrine:1100}},
    {id:15, name:"æ–°æ½ŸçœŒ", pos:[720,480], adj:[6,7,10,16,20], stats:{pop:220, area:12584, temp:13.8, apple:1000, conv:900, shrine:4700}},
    {id:16, name:"å¯Œå±±çœŒ", pos:[650,500], adj:[15,17,20,21], stats:{pop:103, area:4248, temp:14.1, apple:1000, conv:350, shrine:2400}},
    {id:17, name:"çŸ³å·çœŒ", pos:[630,480], adj:[16,18,21], stats:{pop:113, area:4186, temp:14.6, apple:500, conv:400, shrine:2000}},
    {id:18, name:"ç¦äº•çœŒ", pos:[600,530], adj:[17,21,25,26], stats:{pop:76, area:4190, temp:14.9, apple:100, conv:250, shrine:1800}},
    {id:19, name:"å±±æ¢¨çœŒ", pos:[740,580], adj:[11,13,14,20,22], stats:{pop:80, area:4465, temp:14.7, apple:100, conv:400, shrine:800}},
    {id:20, name:"é•·é‡çœŒ", pos:[700,550], adj:[10,11,15,16,19,21,22,23], stats:{pop:204, area:13562, temp:11.9, apple:134700, conv:900, shrine:2500}},
    {id:21, name:"å²é˜œçœŒ", pos:[650,550], adj:[16,17,18,20,23,24,25], stats:{pop:198, area:10621, temp:15.5, apple:1100, conv:800, shrine:3200}},
    {id:22, name:"é™å²¡çœŒ", pos:[730,620], adj:[14,19,20,23], stats:{pop:363, area:7777, temp:17.1, apple:0, conv:1900, shrine:2700}},
    {id:23, name:"æ„›çŸ¥çœŒ", pos:[670,600], adj:[20,21,22,24], stats:{pop:755, area:5173, temp:16.6, apple:0, conv:3700, shrine:3300}},
    {id:24, name:"ä¸‰é‡çœŒ", pos:[630,620], adj:[21,23,25,26,29,30], stats:{pop:177, area:5774, temp:16.3, apple:0, conv:700, shrine:1800}},
    {id:25, name:"æ»‹è³€çœŒ", pos:[600,580], adj:[18,21,24,26], stats:{pop:141, area:4017, temp:14.9, apple:0, conv:500, shrine:2300}},
    {id:26, name:"äº¬éƒ½åºœ", pos:[570,570], adj:[18,24,25,27,28,29], stats:{pop:257, area:4612, temp:15.9, apple:0, conv:1000, shrine:3100}},
    {id:27, name:"å¤§é˜ªåºœ", pos:[560,600], adj:[26,28,29,30], stats:{pop:880, area:1905, temp:17.0, apple:0, conv:3900, shrine:1700}},
    {id:28, name:"å…µåº«çœŒ", pos:[530,580], adj:[26,27,29,31,33,36,37], stats:{pop:543, area:8401, temp:16.5, apple:300, conv:2100, shrine:4000}},
    {id:29, name:"å¥ˆè‰¯çœŒ", pos:[580,620], adj:[24,26,27,28,30], stats:{pop:132, area:3691, temp:15.0, apple:0, conv:450, shrine:1900}},
    {id:30, name:"å’Œæ­Œå±±çœŒ", pos:[560,650], adj:[24,27,29,36], stats:{pop:92, area:4725, temp:16.7, apple:0, conv:300, shrine:1100}},
    {id:31, name:"é³¥å–çœŒ", pos:[480,570], adj:[28,32,33], stats:{pop:55, area:3507, temp:15.2, apple:1000, conv:200, shrine:900}},
    {id:32, name:"å³¶æ ¹çœŒ", pos:[440,580], adj:[31,34,35], stats:{pop:67, area:6708, temp:15.0, apple:100, conv:230, shrine:1400}},
    {id:33, name:"å²¡å±±çœŒ", pos:[490,600], adj:[28,31,34,37], stats:{pop:188, area:7115, temp:16.0, apple:300, conv:800, shrine:1500}},
    {id:34, name:"åºƒå³¶çœŒ", pos:[450,610], adj:[32,33,35,38], stats:{pop:279, area:8479, temp:16.3, apple:1100, conv:1200, shrine:1900}},
    {id:35, name:"å±±å£çœŒ", pos:[400,610], adj:[32,34,38,40,44], stats:{pop:134, area:6112, temp:16.0, apple:300, conv:600, shrine:1200}},
    {id:36, name:"å¾³å³¶çœŒ", pos:[510,650], adj:[28,30,37,38,39], stats:{pop:72, area:4147, temp:16.8, apple:0, conv:300, shrine:1300}},
    {id:37, name:"é¦™å·çœŒ", pos:[490,630], adj:[28,33,36,38], stats:{pop:95, area:1877, temp:16.7, apple:0, conv:350, shrine:800}},
    {id:38, name:"æ„›åª›çœŒ", pos:[450,650], adj:[34,35,36,37,39,44], stats:{pop:133, area:5676, temp:16.6, apple:200, conv:500, shrine:1200}},
    {id:39, name:"é«˜çŸ¥çœŒ", pos:[470,680], adj:[36,38], stats:{pop:69, area:7104, temp:17.3, apple:0, conv:250, shrine:2000}},
    {id:40, name:"ç¦å²¡çœŒ", pos:[350,600], adj:[35,41,42,44], stats:{pop:513, area:4987, temp:17.2, apple:100, conv:2300, shrine:3300}},
    {id:41, name:"ä½è³€çœŒ", pos:[320,610], adj:[40,42], stats:{pop:80, area:2441, temp:16.8, apple:100, conv:350, shrine:800}},
    {id:42, name:"é•·å´çœŒ", pos:[300,620], adj:[40,41,43], stats:{pop:131, area:4131, temp:17.3, apple:0, conv:500, shrine:1300}},
    {id:43, name:"ç†Šæœ¬çœŒ", pos:[350,650], adj:[40,41,42,44,45,46], stats:{pop:173, area:7409, temp:17.2, apple:0, conv:800, shrine:1900}},
    {id:44, name:"å¤§åˆ†çœŒ", pos:[380,630], adj:[35,38,40,43,45], stats:{pop:112, area:6341, temp:16.6, apple:100, conv:450, shrine:1500}},
    {id:45, name:"å®®å´çœŒ", pos:[370,680], adj:[43,44,46], stats:{pop:106, area:7735, temp:17.5, apple:0, conv:450, shrine:800}},
    {id:46, name:"é¹¿å…å³¶çœŒ", pos:[340,710], adj:[43,45,47], stats:{pop:158, area:9187, temp:18.6, apple:0, conv:700, shrine:1300}},
    {id:47, name:"æ²–ç¸„çœŒ", pos:[200,800], adj:[46], stats:{pop:146, area:2282, temp:23.3, apple:0, conv:600, shrine:100}}
];

const STATS_META = {
    pop: {label: "äººå£", unit: "ä¸‡äºº", desc: "äººãŒå¤šã„å ´æ‰€ã‚’é¸ã¼ã†ï¼éƒ½ä¼šã¯æ•°å­—ãŒå¤§ãã„ãã€‚"},
    area: {label: "é¢ç©", unit: "kmÂ²", desc: "åºƒã„å ´æ‰€ã‚’é¸ã¼ã†ï¼å±±ãŒå¤šã„çœŒã¯æœ‰åˆ©ã‹ã‚‚ï¼Ÿ"},
    temp: {label: "å¹³å‡æ°—æ¸©", unit: "â„ƒ", desc: "æ¸©ã‹ã„å ´æ‰€ã‚’é¸ã¼ã†ï¼å—ã«è¡ŒããŒã¡ãªã®ã§æ³¨æ„ï¼"},
    apple: {label: "ãƒªãƒ³ã‚´ç”Ÿç”£", unit: "t", desc: "å¯’ã„åœ°æ–¹ãŒæœ‰åˆ©ãªæ•°å­—ï¼åŒ—æµ·é“ã«è¿‘ã¥ã‘ã‚‹ãƒãƒ£ãƒ³ã‚¹ï¼Ÿ"},
    conv: {label: "ã‚³ãƒ³ãƒ“ãƒ‹æ•°", unit: "åº—èˆ—", desc: "ä¾¿åˆ©ãªãŠåº—ãŒå¤šã„ã®ã¯ã©ã“ã ï¼Ÿäººå£ã¨é–¢ä¿‚ãŒã‚ã‚‹ã‹ã‚‚ã€‚"},
    shrine: {label: "ç¥ç¤¾ã®æ•°", unit: "ç¤¾", desc: "æ­´å²ãŒå¤ã„å ´æ‰€ã‚„ã€æ‘ãŒå¤šã„å ´æ‰€ã«å¤šã„ãã€‚"}
};

// ç°¡æ˜“SVGãƒ‘ã‚¹ä½œæˆç”¨ (ã‚°ãƒªãƒƒãƒ‰çŠ¶ã«é…ç½®ã—ãŸå…­è§’å½¢ã«è¿‘ã„ãƒãƒªã‚´ãƒ³ã¨ã—ã¦æç”»)
function generateMap() {
    const svg = document.getElementById('japan-map');
    
    PREF_DATA.forEach(pref => {
        // ç°¡æ˜“çš„ãªãƒãƒªã‚´ãƒ³ç”Ÿæˆï¼ˆå††å½¢ã«è¿‘ã„ãƒ‘ã‚¹ï¼‰
        const [x, y] = pref.pos;
        const size = 15; // çœŒã®ã‚µã‚¤ã‚º
        
        // åŒ—æµ·é“ã‚„å¤§ããªçœŒã¯å°‘ã—å¤§ããã™ã‚‹è¦–è¦šè£œæ­£
        let radius = size;
        if(pref.id === 1) radius = 30; // åŒ—æµ·é“
        if(pref.id === 47) radius = 10; // æ²–ç¸„
        
        // å…­è§’å½¢ãƒ‘ã‚¹ã®ç”Ÿæˆ
        let d = "";
        for(let i=0; i<6; i++){
            const angle = (Math.PI / 3) * i;
            const px = x + Math.cos(angle) * radius;
            const py = y + Math.sin(angle) * radius * 0.8; // ç¸¦ã«ã¤ã¶ã—ã¦åœ°å›³ã£ã½ã
            d += (i===0 ? "M" : "L") + px + "," + py;
        }
        d += "Z";
        
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", d);
        path.setAttribute("class", "pref");
        path.setAttribute("id", "pref-" + pref.id);
        path.addEventListener('click', () => alert(pref.name)); // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆå®Ÿéš›ã¯ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹ï¼‰
        
        // ãƒ†ã‚­ã‚¹ãƒˆé…ç½®
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", x);
        text.setAttribute("y", y + 4);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("fill", "#333");
        text.setAttribute("font-size", "10px");
        text.setAttribute("pointer-events", "none");
        text.textContent = pref.name.substring(0, 2); // 2æ–‡å­—è¡¨ç¤º
        
        svg.appendChild(path);
        svg.appendChild(text);
    });
    
    // æ¥ç¶šç·šã‚’æç”»ï¼ˆéš£æ¥é–¢ä¿‚ã®å¯è¦–åŒ–ï¼‰
    PREF_DATA.forEach(pref => {
        pref.adj.forEach(adjId => {
            if(pref.id < adjId) { // é‡è¤‡æç”»é˜²æ­¢
                const target = PREF_DATA.find(p => p.id === adjId);
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", pref.pos[0]);
                line.setAttribute("y1", pref.pos[1]);
                line.setAttribute("x2", target.pos[0]);
                line.setAttribute("y2", target.pos[1]);
                line.setAttribute("stroke", "rgba(255,255,255,0.3)");
                line.setAttribute("stroke-width", "1");
                svg.insertBefore(line, svg.firstChild);
            }
        });
    });
}

/**
 * ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
 */
const game = {
    currentId: 47, // æ²–ç¸„ã‚¹ã‚¿ãƒ¼ãƒˆ
    turn: 1,
    history: [], // {from, to, stat, isGood}
    
    init: () => {
        generateMap();
        game.updateDisplay();
        game.generateOptions();
        game.highlightMap();
    },

    // é¸æŠè‚¢ï¼ˆ3ã¤ï¼‰ã‚’ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
    generateOptions: () => {
        const keys = Object.keys(STATS_META);
        const options = [];
        
        // å¿…ãšã€ŒåŒ—ä¸Šã§ãã‚‹ï¼ˆIDãŒå°ã•ããªã‚‹ï¼‰ã€é¸æŠè‚¢ãŒå«ã¾ã‚Œã‚‹ã‚ˆã†ã«èª¿æ•´ã™ã‚‹ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯
        // ä»Šå›ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã¯ã€ŒåŒ—æµ·é“ã«è¿‘ã¥ãï¼IDãŒæ¸›ã‚‹ã€ã¨å˜ç´”åŒ–
        // ãŸã ã—ã€å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã§å‹ã¦ã‚‹ã¨ã¯é™ã‚‰ãªã„ãŸã‚ã€ãƒ©ãƒ³ãƒ€ãƒ ã«3ã¤é¸å‡º
        while(options.length < 3) {
            const k = keys[Math.floor(Math.random() * keys.length)];
            if(!options.includes(k)) options.push(k);
        }

        const container = document.getElementById('options-container');
        container.innerHTML = "";
        
        options.forEach(key => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerHTML = `<strong>${STATS_META[key].label}</strong><br><span style="font-size:0.8rem">ã§å‹è² !</span>`;
            btn.onclick = () => game.resolveTurn(key);
            // ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼éŸ³
            btn.onmouseenter = () => Sound.playTone(800, 'sine', 0.05);
            container.appendChild(btn);
        });
    },

    // ã‚¿ãƒ¼ãƒ³å‡¦ç†
    resolveTurn: (statKey) => {
        Sound.drum(); // ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«é–‹å§‹ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
        
        const currentPref = PREF_DATA.find(p => p.id === game.currentId);
        
        // æ¯”è¼ƒå¯¾è±¡: è‡ªåˆ† + éš£æ¥çœŒ
        const targets = [currentPref, ...currentPref.adj.map(id => PREF_DATA.find(p => p.id === id))];
        
        // æ•°å€¤ãŒæœ€å¤§ã®çœŒã‚’æ¢ã™
        let maxVal = -1;
        let winner = null;
        
        targets.forEach(p => {
            const val = p.stats[statKey];
            if(val > maxVal) {
                maxVal = val;
                winner = p;
            } else if (val === maxVal) {
                // åŒå€¤ã®å ´åˆã€åŒ—æµ·é“ã«è¿‘ã„æ–¹(IDãŒå°ã•ã„æ–¹)ã‚’å„ªå…ˆ
                if(p.id < winner.id) winner = p;
            }
        });
        
        // ç§»å‹•åˆ¤å®š
        const prevId = game.currentId;
        const nextId = winner.id;
        game.currentId = nextId;
        
        // è‰¯ã„ç§»å‹•ã ã£ãŸã‹ï¼Ÿ (IDãŒæ¸›ã£ã¦ã„ã‚Œã°åŒ—ä¸ŠæˆåŠŸã¨ã¿ãªã™ â€»ç°¡æ˜“åˆ¤å®š)
        // åŒ—æµ·é“(1) < æ²–ç¸„(47)
        let isGood = false;
        let resultMsg = "";
        
        if (nextId === 1) {
            isGood = true; // ã‚´ãƒ¼ãƒ«
        } else if (nextId < prevId) {
            isGood = true;
            resultMsg = "åŒ—ä¸ŠæˆåŠŸï¼åŒ—æµ·é“ã«è¿‘ã¥ã„ãŸï¼";
            Sound.ok();
        } else if (nextId > prevId) {
            isGood = false;
            resultMsg = "å—ä¸‹ã—ã¦ã—ã¾ã£ãŸ...æ²–ç¸„ã«é€†æˆ»ã‚Šï¼Ÿ";
            Sound.bad();
        } else {
            isGood = false;
            resultMsg = "è¶³æ­¢ã‚ï¼å‘¨ã‚Šã®çœŒã‚ˆã‚Šæ•°å€¤ãŒé«˜ã‹ã£ãŸ...";
            Sound.bad();
        }
        
        // å±¥æ­´ä¿å­˜
        game.history.push({
            from: currentPref.name,
            to: winner.name,
            stat: STATS_META[statKey].label,
            statKey: statKey,
            val: maxVal,
            isGood: isGood
        });
        
        game.highlightMap();
        game.showResult(statKey, currentPref, winner, targets, isGood, resultMsg);
    },

    showResult: (statKey, fromPref, toPref, group, isGood, msg) => {
        const modal = document.getElementById('modal');
        const title = document.getElementById('modal-title');
        const badge = document.getElementById('modal-badge');
        const message = document.getElementById('modal-msg');
        const dataBox = document.getElementById('modal-data');
        const memo = document.getElementById('modal-memo');
        
        // ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
        title.innerText = toPref.id === 1 ? "åŒ—æµ·é“ã«åˆ°é”ï¼" : (fromPref.id === toPref.id ? "ç§»å‹•ã›ãš" : toPref.name + " ã¸ç§»å‹•ï¼");
        badge.innerText = isGood ? "NICE MOVE!" : "BAD MOVE...";
        badge.className = "result-badge " + (isGood ? "res-good" : "res-bad");
        message.innerText = msg;
        
        // è§£èª¬ç”Ÿæˆ
        const meta = STATS_META[statKey];
        let memoText = meta.desc + "<br>";
        memoText += `<strong>${toPref.name}</strong>ã®${meta.label}ã¯ <strong>${toPref.stats[statKey].toLocaleString()}${meta.unit}</strong> ã§ã™ã€‚`;
        memo.innerHTML = memoText;
        
        // ãƒ‡ãƒ¼ã‚¿æ¯”è¼ƒãƒªã‚¹ãƒˆä½œæˆ (é™é †ã‚½ãƒ¼ãƒˆ)
        const sorted = [...group].sort((a,b) => b.stats[statKey] - a.stats[statKey]);
        let html = "";
        sorted.forEach((p, index) => {
            const isWinner = p.id === toPref.id;
            html += `<div class="data-row ${isWinner ? 'winner' : ''}">
                <span>${index+1}. ${p.name}</span>
                <span>${p.stats[statKey].toLocaleString()}${meta.unit}</span>
            </div>`;
        });
        dataBox.innerHTML = html;
        
        modal.classList.add('show');
        
        // ã‚´ãƒ¼ãƒ«åˆ¤å®šãªã‚‰ç‰¹åˆ¥æ¼”å‡º
        if(game.currentId === 1) {
            document.querySelector('.next-btn').innerText = "æ„Ÿå‹•ã®ã‚´ãƒ¼ãƒ«ã¸";
            document.querySelector('.next-btn').onclick = game.startEnding;
        } else {
            document.querySelector('.next-btn').innerText = "æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸";
            document.querySelector('.next-btn').onclick = game.closeModal;
        }
    },
    
    closeModal: () => {
        document.getElementById('modal').classList.remove('show');
        game.turn++;
        game.updateDisplay();
        game.generateOptions();
        Sound.move();
    },

    updateDisplay: () => {
        document.getElementById('curr-pref-name').innerText = PREF_DATA.find(p=>p.id===game.currentId).name;
        document.getElementById('dist-count').innerText = game.currentId - 1; // IDå·®åˆ†ã‚’è·é›¢ã¨ã™ã‚‹
        document.getElementById('turn-count').innerText = game.turn;
    },

    highlightMap: () => {
        // å…¨ãƒªã‚»ãƒƒãƒˆ
        document.querySelectorAll('.pref').forEach(el => {
            el.classList.remove('current', 'neighbor', 'visited', 'goal');
        });
        
        // å±¥æ­´ã‚’visitedã«
        const visitedIds = new Set();
        // ç¾åœ¨åœ°ã‚‚å«ã‚ã‚‹
        visitedIds.add(game.currentId); 
        game.history.forEach(h => {
             // åå‰ã‹ã‚‰IDé€†å¼•ãã¯é¢å€’ãªã®ã§ç°¡æ˜“å‡¦ç†ãªã—ã§ã‚‚ã‚ˆã„ãŒã€æ¼”å‡ºã¨ã—ã¦è¶³è·¡ã‚’ã¤ã‘ã‚‹
        });

        // ç¾åœ¨åœ°
        const currEl = document.getElementById('pref-' + game.currentId);
        if(currEl) currEl.classList.add('current');
        
        // åŒ—æµ·é“
        document.getElementById('pref-1').classList.add('goal');

        // éš£æ¥
        const currData = PREF_DATA.find(p => p.id === game.currentId);
        currData.adj.forEach(adjId => {
            const el = document.getElementById('pref-' + adjId);
            if(el) el.classList.add('neighbor');
        });
    },
    
    startEnding: () => {
        document.getElementById('modal').classList.remove('show');
        document.getElementById('endroll').style.display = 'flex';
        Sound.fanfare();
        startConfetti(); // ç´™å¹é›ª
        
        // å±¥æ­´è¡¨ç¤º
        const list = document.getElementById('history-list');
        game.history.forEach((h, i) => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div>Step ${i+1}: ${h.from} â†’ ${h.to}</div>
                <div style="font-size:0.8rem; color:${h.isGood ? '#7bed9f':'#ff7675'}">
                    ã€Œ${h.stat}ã€ã‚’é¸æŠ
                </div>
            `;
            list.appendChild(div);
        });
    }
};

// ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ (Canvas)
let confettiActive = false;
function startConfetti() {
    confettiActive = true;
    const canvas = document.getElementById('confetti');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const pieces = [];
    for(let i=0; i<100; i++){
        pieces.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height,
            color: `hsl(${Math.random()*360}, 100%, 50%)`,
            size: Math.random() * 10 + 5,
            speed: Math.random() * 3 + 2
        });
    }
    
    function loop() {
        if(!confettiActive) return;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        pieces.forEach(p => {
            p.y += p.speed;
            if(p.y > canvas.height) p.y = -20;
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, p.size, p.size);
        });
        requestAnimationFrame(loop);
    }
    loop();
}

// ã‚²ãƒ¼ãƒ é–‹å§‹
window.onload = game.init;

</script>
</body>
</html>
